<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helpdesk Control Room</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="noise"></div>
<div class="orb orb-a"></div>
<div class="orb orb-b"></div>

<div class="app-shell">
    <aside class="side-panel tilt-card">
        <div class="brand">
            <p class="brand-kicker">Campus Ops</p>
            <h1>Helpdesk</h1>
            <p th:text="${currentUser.fullName}"></p>
            <p class="role-pill" th:text="${currentUser.role}"></p>
        </div>

        <div class="mini-stats" th:if="${isManagement}">
            <div class="mini-box">
                <span>Submitted</span>
                <strong th:text="${statusSummary['SUBMITTED']}">0</strong>
            </div>
            <div class="mini-box">
                <span>In Progress</span>
                <strong th:text="${statusSummary['IN_PROGRESS']}">0</strong>
            </div>
            <div class="mini-box">
                <span>Resolved</span>
                <strong th:text="${statusSummary['RESOLVED'] + statusSummary['CLOSED']}">0</strong>
            </div>
        </div>

        <form th:action="@{/logout}" method="post" class="logout-wrap">
            <button type="submit" class="btn ghost">Logout</button>
        </form>
    </aside>

    <main class="main-panel">
        <section class="hero tilt-card">
            <div>
                <h2>Complaint Command Center</h2>
                <p>Track, assign, resolve, and escalate complaints with clear ownership.</p>
            </div>
            <div class="chips-row">
                <span class="chip" th:if="${isStudent}">Student View</span>
                <span class="chip" th:if="${isStaff}">Staff View</span>
                <span class="chip" th:if="${isManagement}">Management View</span>
            </div>
        </section>

        <div class="alert success" th:if="${successMessage}" th:text="${successMessage}"></div>
        <div class="alert error" th:if="${errorMessage}" th:text="${errorMessage}"></div>

        <section class="panel-grid" th:if="${isManagement}">
            <article class="tile tilt-card">
                <h3>Department Pressure</h3>
                <div class="meter" th:each="d : ${departmentStats}">
                    <label th:text="${d.department}"></label>
                    <div class="meter-track"><div class="meter-fill" th:style="'width:' + (${d.total} * 10) + 'px'"></div></div>
                    <span th:text="${d.total}"></span>
                </div>
            </article>
            <article class="tile tilt-card">
                <h3>Monthly Intake</h3>
                <div class="meter" th:each="m : ${monthlyTrend}">
                    <label th:text="${m.period}"></label>
                    <div class="meter-track"><div class="meter-fill alt" th:style="'width:' + (${m.total} * 10) + 'px'"></div></div>
                    <span th:text="${m.total}"></span>
                </div>
            </article>
        </section>

        <section class="submit-panel tilt-card" th:if="${isStudent}">
            <h3>Raise New Complaint</h3>
            <form th:action="@{/student/complaints}" th:object="${complaintForm}" method="post" enctype="multipart/form-data" class="form-pro">
                <div>
                    <label>Title</label>
                    <input type="text" th:field="*{title}" placeholder="Eg: Lab system not booting">
                    <small th:errors="*{title}"></small>
                </div>
                <div>
                    <label>Priority</label>
                    <select th:field="*{priority}">
                        <option th:each="p : ${priorities}" th:value="${p}" th:text="${p}"></option>
                    </select>
                </div>
                <div>
                    <label>Category</label>
                    <select th:field="*{category}">
                        <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}"></option>
                    </select>
                </div>
                <div class="full">
                    <label>Description</label>
                    <textarea rows="4" th:field="*{description}" placeholder="Give full context"></textarea>
                    <small th:errors="*{description}"></small>
                </div>
                <div class="full">
                    <label>Attachments</label>
                    <input type="file" name="files" multiple>
                </div>
                <button type="submit" class="btn">Submit Complaint</button>
            </form>
        </section>

        <section class="board tilt-card">
            <div class="board-head">
                <h3>Live Complaint Queue</h3>
                <p>Every role sees only authorized records.</p>
            </div>

            <div class="list" th:if="${#lists.isEmpty(complaints)}">
                <div class="empty">No complaints available right now.</div>
            </div>

            <article class="case-card" th:each="c : ${complaints}">
                <header>
                    <div>
                        <h4 th:text="${'#' + c.id + ' - ' + c.title}"></h4>
                        <p th:text="${c.description}"></p>
                    </div>
                    <div class="case-tags">
                        <span class="chip" th:text="${c.category}"></span>
                        <span class="chip" th:text="${c.priority}"></span>
                        <span class="chip status" th:text="${c.status}"></span>
                        <span class="chip danger" th:if="${c.escalated}">Escalated</span>
                    </div>
                </header>

                <div class="case-meta">
                    <span th:text="${'Student: ' + c.student.fullName}"></span>
                    <span th:text="${'Assigned: ' + (c.assignedTo != null ? c.assignedTo.fullName : 'Unassigned')}"></span>
                    <span th:text="${'SLA: ' + #temporals.format(c.escalationDueAt, 'dd MMM HH:mm')}"></span>
                </div>

                <div class="actions-wrap">
                    <form th:if="${isManagement}" th:action="@{/management/complaints/{id}/assign(id=${c.id})}" method="post" class="inline-form">
                        <select name="staffUserId" required>
                            <option value="" selected disabled>Assign staff</option>
                            <option th:each="s : ${staffUsers}" th:value="${s.id}" th:text="${s.fullName}"></option>
                        </select>
                        <button type="submit" class="btn">Assign</button>
                    </form>

                    <form th:if="${isStaff or isManagement}" th:action="@{/staff/complaints/{id}/status(id=${c.id})}" method="post" class="inline-form">
                        <select name="status">
                            <option th:each="st : ${statuses}" th:value="${st}" th:text="${st}" th:selected="${st == c.status}"></option>
                        </select>
                        <button type="submit" class="btn">Update</button>
                    </form>

                    <form th:action="@{/complaints/{id}/notes(id=${c.id})}" method="post" class="inline-form fullrow">
                        <input type="text" name="message" placeholder="Write progress note">
                        <button type="submit" class="btn">Add Note</button>
                    </form>

                    <form th:action="@{/complaints/{id}/attachments(id=${c.id})}" method="post" enctype="multipart/form-data" class="inline-form fullrow">
                        <input type="file" name="file" required>
                        <button type="submit" class="btn">Upload</button>
                    </form>
                </div>

                <div class="timeline-grid">
                    <section>
                        <h5>Notes</h5>
                        <div class="note" th:each="n : ${notesMap[c.id]}">
                            <small th:text="${n.author.fullName + ' · ' + #temporals.format(n.createdAt, 'dd MMM HH:mm')}"></small>
                            <p th:text="${n.message}"></p>
                        </div>
                    </section>

                    <section>
                        <h5>Attachments</h5>
                        <div class="note" th:if="${#lists.isEmpty(attachmentsMap[c.id])}">
                            <small>No files</small>
                        </div>
                        <div class="note" th:each="a : ${attachmentsMap[c.id]}">
                            <a th:href="@{/attachments/{id}(id=${a.id})}" th:text="${a.originalFileName}"></a>
                            <small th:text="${'by ' + a.uploadedBy.fullName}"></small>
                        </div>
                    </section>
                </div>
            </article>
        </section>
    </main>
</div>

<script th:src="@{/js/app.js}"></script>
</body>
</html>
